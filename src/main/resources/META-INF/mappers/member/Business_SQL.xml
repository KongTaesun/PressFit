<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- java Resource/src/main/resources/mappers/
    businessMapper.xml -->
<!-- 다른 mapper와 중복되지 않도록 네임스페이스 기재 -->
<mapper namespace="business">
	<select id="businessList" resultType="kr.co.pressfit.vo.BusinessVO">
		select * from Cbusiness
	</select>
	 
	<insert id="insertBusiness" parameterType="kr.co.pressfit.vo.BusinessVO">
	insert into Cbusiness 
	(id,pw,name,gender,birth,basic_addr,detail_addr,post,email,hp,companyname,companytp, representative, corporateregistrationnumber, typeofbusiness, itemsofbusiness, companyaddress, regdate ) 
	values (#{id},#{pw},#{name},#{gender},#{birth},#{basic_addr},#{detail_addr},#{post},#{email},#{hp},#{address},
	#{companyname}, #{companytp}, #{representative}, #{corporateregistrationnumber}, #{typeofbusiness}, #{itemsofbusiness}, #{companyaddress}, NOW() )	
	
	</insert>
	
	<select id="viewBusiness" resultType="kr.co.pressfit.vo.BusinessVO">
	select * from Cbusiness
	where id=#{id}
	</select>
	<!-- 회원정보 수정 --> 
	<update id="updateBusiness"> 
	update Cbusiness
	set pw=#{pw}, name=#{name}
		,email=#{email}, updatedate=now()
	where id=#{id}
	</update> 
	<!-- 회원정보 삭제 -->
	<delete id="deleteBusiness">
		delete from Cbusiness 
		where id=#{id} 
	</delete>
	<!-- 비밀번호 체크 -->	
	<select id="checkPw" resultType="int">
		select count(*) from Cbusiness
		where id=#{id} and pw=#{pw}
	</select>
	
	 <!-- 2. 주문 들어온 목록 -->
    <select id="orderList" resultType="kr.co.pressfit.vo.CartVO">
        SELECT *,(price * amount) money 
        FROM cart_board
        where payment ='Y'
        <include refid="search"></include>
        AND crea_id = #{id}
        ORDER BY cart_id
    </select>
    
    <sql id="search">
      <if test="searchOption=='order'">
         and (shippingStatus = '0'
         or shippingStatus = '1'
         or shippingStatus = '2')
      </if>
      <if test="searchOption=='refund'">
         and (shippingStatus = '3'
         or shippingStatus = '4')
      </if>
      <if test="searchOption=='exchange'">
         and (shippingStatus = '5'
         or shippingStatus = '6')
      </if>
   </sql>
    
    <!-- 페이징 sql -->
	<sql id="pagingHeader">
	   SELECT A.* 
		FROM (
	</sql>
	<sql id="pagingFooter">
		) A
		WHERE A.ROWNUM BETWEEN #{start} AND #{end}
		ORDER BY ROWNUM
	</sql>
	<!-- 01_02. 게시글 레코드 갯수 -->
	<select id="countArticle" resultType="int">
	 	
	    SELECT COUNT(*) 
	    FROM cart_board
		WHERE payment ='Y'
	    <!-- WHERE절을 include 태그로 삽입 -->
	    <include refid="search"></include>
	    AND crea_id = #{id}
	 
	</select>
    
    <!-- 3. 주문 전체 금액 -->
    <select id="sumMoney" resultType="int">
        SELECT ifnull(SUM(c.price * c.amount), 0) money
        FROM cart_board c, TMouseBoard p
        WHERE c.idx = p.idx AND c.payment = 'N' and c.shippingStatus = '0' AND c.crea_id = #{id} 
    </select>
    
    <!-- 결제 -->
    <update id="payment" parameterType="hashmap">
		update cart_board
		<if test="searchOption=='order'">
        	set shippingStatus = '1'
			where cart_id = #{num}
      	</if>
      	<if test="searchOption=='refund'">
        	set shippingStatus = '4'
			where cart_id = #{num}
      	</if>
      	<if test="searchOption=='exchange'">
        	set shippingStatus = '6'
			where cart_id = #{num}
      	</if>
		
	</update>
	
	<!-- 환불시 제품 수량 원복 -->
	<update id="amounttest_keyboard" parameterType="kr.co.pressfit.vo.CartVO">
		update KeyboardBoard
		set amount = amount + #{amount}, salesTotal = salesTotal - #{amount}
 		where idx = #{idx}
	</update>
		
	<update id="amounttest_mouse" parameterType="kr.co.pressfit.vo.CartVO">
		update TMouseBoard
		set amount = amount + #{amount}, salesTotal = salesTotal - #{amount}
		where idx = #{idx}
	</update>
</mapper>

 












